function getNl(method,value,callback,max_id){return $.ajax({type:"GET",dataType:"json",url:"/controller_nl.php?action=nlGetMethod",data:{method:method,value:value,max_id:max_id},success:callback,error:function(){}}),!1}function getTagGrid(feed){return resultatControleRetour=controleRetour(feed),resultatControleRetour&&(hideLoader($("#conteneurLoaderEnCours")),feed.modeViewer=app_controller.mode,_.each(feed.data,function(pic){pic.show_user_username=!0,void 0===pic.images.low_resolution.url&&(pic.images={low_resolution:{url:pic.images.low_resolution},thumbnail:{url:pic.images.thumbnail},standard_resolution:{url:pic.images.standard_resolution}}),"video"==pic.type&&(pic.popinVideo=1);var model=new Photo(pic);photos.add(model);var view=new photoGridView({model:model});$("#conteneurLoad").append($(view.render().el).emoji())}),void 0!=feed.pagination&&void 0!=feed.pagination.next_max_id&&($("#conteneurLoad").append('<div id="conteneur-more"><a href="#" class="more" id="more-gettaggrid-'+feed.pagination.next_max_id+'-0">'+$("#trad-more").val()+"</a></div>"),paginationScroll()),getPopular(),afficheBoutonsPartage(),lazyload()),!1}function getTagList(feed){return resultatControleRetour=controleRetour(feed),resultatControleRetour&&(hideLoader($("#conteneurLoaderEnCours")),feed.modeViewer=app_controller.mode,_.each(feed.data,function(pic){pic.show_user_username=!0,pic=adaptePicPourListApi(pic);var model=new Photo(pic);photos.add(model);var view=new photoListView({model:model});$("#conteneurLoad").append($(view.render().el).emoji());var posUser=$.inArray(pic.user.id,usersProtect);-1!=posUser&&($("#detailPhoto-"+pic.id).find("#partage").empty(),$("#detailPhoto-"+pic.id).find(".share-url").empty())}),void 0!=feed.pagination&&void 0!=feed.pagination.next_max_id&&($("#conteneurLoad").append('<div id="conteneur-more"><a href="#" class="more" id="more-gettaglist-'+feed.pagination.next_max_id+'-0">'+$("#trad-more").val()+"</a></div>"),paginationScroll()),$("textarea[placeholder]").placeholder(),getPopular(),parsingCaption(),parsingHashtags(),afficheBoutonsPartage(),parsingPhotoOfYou(),lazyload()),!1}function getPopular(){var array_photo_id=photos.map(function(photo){return photo.id}),json_string=JSON.stringify(array_photo_id);$.post("/controller_ajax.php",{action:"popular",photos:json_string},function(data){data&&(photos_popular=JSON.parse(data),_.each(photos_popular,function(photos_id){$("#detailPhoto-"+photos_id).find(".popular_picto").length&&$("#detailPhoto-"+photos_id).find(".popular_picto").show(),$("#detailPhoto-"+photos_id).find(".popular_picto_list").length&&$("#detailPhoto-"+photos_id).find(".popular_picto_list").show()}))})}function getDetail(retour){if(resultatControleRetour=controleRetour(retour)){retour.modeViewer=app_controller.mode,retour.urlAllPhotos="#/user/"+app_controller.user_consulte_id+"/"+app_controller.mode,retour.data.partage=!0,hideLoader($("#conteneurLoaderEnCours")),1==app_controller.initDisplay&&$("#conteneurLoad").html("");var pic=adaptePicPourListApi(retour.data);pic.show_facebook_comments=!0;var model=new Photo(pic);photos.add(model);var view=new photoListView({model:model});$("#conteneurLoad").append($(view.render().el).emoji()),$("textarea[placeholder]").placeholder();var url=$("#user_urlbase").val()+"p/"+$("#idPhoto").val();$(".bloc-comm-fb").html('<div id="fb-root"></div><script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:comments href="'+url+'" num_posts="3" width="350"></fb:comments>'),setTimeout(function(){FB.XFBML.parse()},1e3),getPopular(),parsingCaption(),parsingHashtags();var posUser=$.inArray(pic.user.id,usersProtect);-1==posUser?afficheBoutonsPartage():($("#detailPhoto-"+pic.id).find("#partage").empty(),$("#detailPhoto-"+pic.id).find(".share-url").empty()),parsingPhotoOfYou(),lazyload()}return!1}function getSearch(word){if(!word){var stringSearch=$("#getSearch").val();return"#"===stringSearch.charAt(0)&&(stringSearch=stringSearch.substr(1)),document.location.href="/search/"+stringSearch,!1}var stringSearch=word;testRetour=setInterval("controleRetourSearch()",100),$("#conteneurProfilLarge").html(""),stringSearch=$.trim(stringSearch),stringSearch=stringSearch.replace(/(^@|^#)/,""),valeurSearch=Array(),valeurSearch.search=decodeURIComponent(stringSearch);var modelSearch=new Search(valeurSearch);search.add(modelSearch);var view=new searchView({model:modelSearch});$("#conteneurLoad").html($(view.render().el)),stringSearchSansAccents=supprimeCaracteresAccentues(stringSearch),stringSearchTag=stringSearch,stringSearchUser=stringSearchSansAccents,displayLoaderSearch("resultatSearchUser"),displayLoaderSearch("resultatSearchTag"),hideLoader("conteneurLoaderEnCours");var modelMenu=new Menu({menuModeExist:!1});menu.add(modelMenu);var view=new menuView({model:modelMenu});return $("#conteneurMenu").html($(view.render().el)),$.ajax({type:"GET",dataType:"json",url:"/controller_nl.php?action=nlGetMethod",data:{method:"search",value:stringSearchTag,max_id:!1},success:function(retourTag){var modelSearchTag=new SearchTag(retourTag);searchTag.add(modelSearchTag);var view=new searchTagView({model:modelSearchTag});$("#resultatSearchTag").html($(view.render().el)),retourTag.end=!0,startSearchTag=retourTag,$.get("/controller_ajax.php",{action:"saveHotTag",retourTag:retourTag,tag:stringSearchTag})},error:function(){startSearchTag=Array(),startSearchTag.end=!0}}),$.ajax({type:"GET",dataType:"json",url:"/controller_nl.php?action=nlGetMethod",data:{method:"findUsername",value:stringSearchUser,max_id:!1},success:function(retourUser){var modelSearchUser=new SearchUser(retourUser);searchUser.add(modelSearchUser);var view=new searchUserView({model:modelSearchUser});$("#resultatSearchUser").html($(view.render().el)),retourUser.end=!0,startSearchUser=retourUser},error:function(){startSearchUser=Array(),startSearchUser.end=!0}}),$("#getSearch").blur(),$("#getSearch").placeholder(),!1}$(document).ready(function(){window.Photo=Backbone.Model.extend(),window.Detailphoto=Backbone.Model.extend(),window.Commentaire=Backbone.Model.extend(),window.Detaillikes=Backbone.Model.extend(),window.Profil=Backbone.Model.extend(),window.Detailcommentaire=Backbone.Model.extend(),window.Pagination=Backbone.Model.extend(),window.Menu=Backbone.Model.extend(),window.UsersGrid=Backbone.Model.extend(),window.UserPrivate=Backbone.Model.extend(),window.Search=Backbone.Model.extend(),window.SearchTag=Backbone.Model.extend(),window.SearchUser=Backbone.Model.extend(),window.MenuModeProfil=Backbone.Model.extend();var PhotosCollection=Backbone.Collection.extend({model:Photo}),DetailphotosCollection=Backbone.Collection.extend({model:Detailphoto}),CommentairesCollection=Backbone.Collection.extend({model:Commentaire}),DetaillikesCollection=Backbone.Collection.extend({model:Detaillikes}),ProfilCollection=Backbone.Collection.extend({model:Profil}),DetailcommentairesCollection=Backbone.Collection.extend({model:Detailcommentaire}),PaginationCollection=Backbone.Collection.extend({model:Pagination}),MenuCollection=Backbone.Collection.extend({model:Menu}),UsersGridCollection=Backbone.Collection.extend({model:UsersGrid}),UserPrivateCollection=Backbone.Collection.extend({model:UserPrivate}),SearchCollection=Backbone.Collection.extend({model:Search}),SearchTagCollection=Backbone.Collection.extend({model:SearchTag}),SearchUserCollection=Backbone.Collection.extend({model:SearchUser}),MenuModeProfilCollection=Backbone.Collection.extend({model:MenuModeProfil});if(window.photos=new PhotosCollection,window.detailphotos=new DetailphotosCollection,window.commentaires=new CommentairesCollection,window.detaillikes=new DetaillikesCollection,window.profils=new ProfilCollection,window.detailcommentaires=new DetailcommentairesCollection,window.pagination=new PaginationCollection,window.menu=new MenuCollection,window.usersGrid=new UsersGridCollection,window.userPrivate=new UserPrivateCollection,window.search=new SearchCollection,window.searchTag=new SearchTagCollection,window.searchUser=new SearchUserCollection,window.menuModeProfil=new MenuModeProfilCollection,window.photoGridView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this,$("#conteneurCommentaire").html("")},render:function(){return this.el=ich.photoGridTemplate(this.model.toJSON()),this}}),window.photoListView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this,$("#conteneurCommentaire").html("")},render:function(){return this.el=ich.photoListTemplate(this.model.toJSON()),this}}),window.commentaireView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.commentaireTemplate(this.model.toJSON()),this}}),window.detaillikesView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.detaillikesTemplate(this.model.toJSON()),this}}),window.detailcommentaireView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.detailcommentaireTemplate(this.model.toJSON()),this}}),window.menuView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.menuTemplate(this.model.toJSON()),this}}),window.searchView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.searchTemplate(this.model.toJSON()),this}}),window.searchTagView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.searchTagTemplate(this.model.toJSON()),this}}),window.searchUserView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.model.bind("change",this.render),this.model.view=this},render:function(){return this.el=ich.searchUserTemplate(this.model.toJSON()),this}}),$("#tag").val())var defaultRoute="getPhotosTag",actionsRoute="getPhotosTag";else if($("#search").val())var defaultRoute="getSearch",actionsRoute="rien";else var defaultRoute="getDetail",actionsRoute="rien";var AppController=Backbone.Controller.extend({mode:"grid",routes:{"/:mode":"getPhotosTag","/detail/:id":"getDetail","/search/:word":"getSearch","!*actions":"changeLayout","":defaultRoute,"_=_":defaultRoute,"*actions":actionsRoute},changeLayout:function(actions){this.mode=actions,window.history.back()},rien:function(){},getPhotosTag:function(mode){var tag=$("#tag").val();if(photos.refresh([]),initialiseAffichage(),this.rechercheTag=tag,this.mode=mode,this.pagePopular=!1,"list"==mode){sauveStat("photosByTag","list"),getNl("mediasTag",tag,getTagList);var model=new Menu({pageEnCours:"tag/"+tag,mode:mode,menuListSelected:!0,menuModeExist:!0,tagDetail:tag,showBackLink:!1})}else{sauveStat("photosByTag","grid"),getNl("mediasTag",tag,getTagGrid);var model=new Menu({pageEnCours:"tag/"+tag,mode:mode,menuGridSelected:!0,menuModeExist:!0,tagDetail:tag,showBackLink:!1})}this.user_consulte_id=null,menu.add(model);var view=new menuView({model:model});$("#conteneurMenu").html($(view.render().el)),$("#getSearch").placeholder(),$(".ariane").html("Viewer > #"+tag)},getDetail:function(photo_id){if(!photo_id)var photo_id=$("#idPhoto").val();photos.refresh([]),initialiseAffichage(),sauveStat("detail","list"),getNl("mediaDetail",photo_id,getDetail);var model=new Menu({mode:this.mode,menuModeExist:!1});menu.add(model);var view=new menuView({model:model});$("#conteneurMenu").html($(view.render().el)),$("#getSearch").placeholder(),this.user_consulte_id=null,this.pagePopular=!1},getSearch:function(word){void 0==word&&(word=$("#search").val()),sauveStat("search",""),photos.refresh([]),getSearch(decodeURIComponent(word)),$(".ariane").html("Viewer > Search > "+word)},defaultRoute:function(){}});window.app_controller=new AppController,Backbone.history.start(),$(".mode-viewer-detail").live("click",function(){$("body").css("overflow","hidden");var overlay=ich.OverlayTemplate();return $("body").append(overlay),photos.each(function(photo){photoObjet=photo.toJSON(),$("#content-photo").append(ich.PhotoOverlayTemplate(photoObjet))}),$("#content-photo").find(".photo-overlay:first").addClass("active"),1>=_.size(photos)?($("#overlay-wrapper").find(".navigation-left").hide(),$("#overlay-wrapper").find(".navigation-right").hide()):($("#overlay-wrapper").find(".navigation-left").show(),$("#overlay-wrapper").find(".navigation-right").show()),resizePhotosSlideshow(),afficheBoutonsPartage(),lazyload(),!1}),$(".navigation-left").find("a").live("click",function(){var current=$("#content-photo").find(".active");current.removeClass("active");var next=current.prev(".photo-overlay");return next.length||(next=$("#content-photo").find(".photo-overlay:last")),next.addClass("active"),!1}),$(".navigation-right").find("a").live("click",function(){var current=$("#content-photo").find(".active");current.removeClass("active");var next=current.next(".photo-overlay");return next.length||(next=$("#content-photo").find(".photo-overlay:first")),next.addClass("active"),!1}),$(".more").live("click",function(){switch(params=$(this).attr("id").split("-"),action=params[1],cursorOrMax_id=params[2],user_consulte_id=params[3],displayLoader($("#conteneurLoaderEnCours")),$(this).parent("#conteneur-more").remove(),action){case"gettaggrid":actionCallback=getTagGrid,getNl("mediasTag",app_controller.rechercheTag,actionCallback,cursorOrMax_id);break;case"gettaglist":actionCallback=getTagList,getNl("mediasTag",app_controller.rechercheTag,actionCallback,cursorOrMax_id);break;default:}return!1}),$(".allCommentsLikes").live("click",function(){switch(params=$(this).attr("id").split("-"),action=params[1],cursorOrMax_id=params[2],user_consulte_id=params[3],action){case"comments":actionCallback=getComments,detailPhoto="detailPhoto-"+cursorOrMax_id,getNl("mediaComments",cursorOrMax_id,actionCallback);break;case"likes":actionCallback=getLikes,detailPhoto="detailPhoto-"+cursorOrMax_id,getNl("mediaLikes",cursorOrMax_id,actionCallback);break;default:}return!1}),$("#searchFormNl").live("submit",function(){return getSearch(),!1}),$(".login-for-comment").live("click",function(){var mediaId=$(this).attr("id").split("login-for-comment-");return $.ajax({type:"GET",data:{action:"loginForComment",mediaId:mediaId[1]},url:"controller_ajax.php",success:function(data){document.location.href=data}}),!1})});